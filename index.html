<style>
  canvas {
    border: 1px solid black;
    margin: auto;
    display: block;
  }
</style>
<canvas id="gc"></canvas>
<script>
function loadScript (dir, file) {
 var scr = document.createElement("script");
 scr.src = dir + file;
 document.body.appendChild(scr);
 return scr;
}
function loadFolder (dir, preNum, num, postNum) {
  var file = preNum + num + postNum;
  var scr = document.createElement("script");
  scr.src = dir + file;
  document.body.appendChild(scr);
  scr.onload = function() {
    loadFolder(dir, preNum, num+1, postNum);
  }
}
function loadSequentially (dir, list) {
    var file = list.shift();
    loadScript(dir, file).onload = function() {
      if(list.length!=0)
      loadSequentially(dir, list);
    };
}
loadSequentially("./",[
  "Blocks/index.js",
  "Worlds/index.js",
  "Scenes/index.js",
]);
</script>
<script src="./math.js"></script>
<script src="./gui.js"></script>
<!--<script src="./Blocks/index.js"></script>-->
<!--<script src="./Worlds/index.js"></script>-->
<script src="./Entities/index.js"></script>
<!--<script src="./Scenes/index.js"></script>-->
<script src="./Animations/Animation.js"></script>
<script>
var movementKeys = [32,37,38,39,40];
class MainDriver {
  constructor() {
    this.frameCount=0;
    this.keys = [];
    this.scene = new MenuScene();
    this.scene.driver = this;
    this.mouse = {x:0,y:0};
  }
  update(dt) {
    this.frameCount+=dt;
    // var time = Date.now();
    // var dt = time-this.lastTime;
    // this.lastTime=time;
    
    this.scene.keys = this.keys;
    this.scene.update(dt, this.frameCount);
  }
  draw(canvas) {
    canvas.clearRect(0,0,canvas.width,canvas.height);
    this.scene.draw(canvas);
  }
  keydown(e) {
    var keys = this.keys;
    var k = e.keyCode;
    if(movementKeys.includes(k)) {
      e.preventDefault();
    }
    if(keys[k])return;
    this.scene.keydown(k);
    keys[k] = true;
  }
  keyup(e) {
    var keys = this.keys;
    var k = e.keyCode;
    if(!keys[k])return;
    this.scene.keyup(k);
    keys[k] = false;
  }
  mousedown(e) {
    var boundingClientRect = e.target.getBoundingClientRect();
    this.mouse.x = e.clientX-boundingClientRect.left;
    this.mouse.y = e.clientY-boundingClientRect.top;
    this.mouse.held = true;
    this.scene.mousedown(e, this.mouse);
  }
  mouseup(e) {
    var boundingClientRect = e.target.getBoundingClientRect();
    this.mouse.x = e.clientX-boundingClientRect.left;
    this.mouse.y = e.clientY-boundingClientRect.top;
    this.mouse.held = false;
    this.scene.mouseup(e, this.mouse);    
  }
  mousemove(e) {
    var boundingClientRect = e.target.getBoundingClientRect();
    this.mouse.x = e.clientX-boundingClientRect.left;
    this.mouse.y = e.clientY-boundingClientRect.top;
    this.scene.mousemove(e, this.mouse);    
  }
  setScene(scene) {
    scene.driver = this;
    this.scene = scene;
  }
}


window.onload = function() {
  var CE = document.getElementById('gc');
  CE.width = 1000;
  CE.height = 600;
  var canvas = CE.getContext('2d');
  canvas.width = CE.width;
  canvas.height = CE.height;
  canvas.font = "30px Arial";
  var driver = new MainDriver();
  var lastTime = Date.now();
  var FPScounter = 0;
  var currentFPS = 0;
  var lastFPSupdate = lastTime;
  function step() {
    var currentTime = Date.now();
    var dt = currentTime-lastTime;
    lastTime = currentTime;
    dt = dt * 60 / 1000;
    FPScounter ++;
    if(currentTime>lastFPSupdate+1000) {
      currentFPS = FPScounter;
      FPScounter=0;
      lastFPSupdate = currentTime;
    }
    driver.update(dt);
    driver.draw(canvas);
    canvas.fillStyle = "white";
    canvas.fillText(currentFPS, 20,20);
    dt = 1;
    canvas.fillText(dt, 40,40);
    // window.requestAnimationFrame(step);
  }
  // step();
  setInterval(step, 1000/60);
  window.addEventListener('keydown', driver.keydown.bind(driver));
  window.addEventListener('keyup', driver.keyup.bind(driver));
  CE.addEventListener('mousemove', driver.mousemove.bind(driver));
  CE.addEventListener('mouseup', driver.mouseup.bind(driver));
  CE.addEventListener('mousedown', driver.mousedown.bind(driver));
}
</script>